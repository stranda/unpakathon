---
title: "March 2016 unpakathon working document"
author: "A Strand"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Work done during March meeting}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

#Summary of plots we looked at during this initial hacakthon

#quick scan for weird data points



```{r,echo=F,results='hide'} 
#Load some libraries
suppressMessages({
  library(unpakathon)
library(dplyr)
library(ggplot2)
library(reshape)
library(GGally)
})
```

#phenotypic distributions in the database (added CofC experiment 2)

Here is the distribution of phenotypes across non-farm experiments.  The numbers correspond to the number of lines assessed for that phenotype *not* the number of plants

```{r}
with(phenolong %>% filter(as.character(meta.experiment) != "farm") %>% select(accession,experiment,variable) %>% distinct(),
     table(variable,experiment))
```



Let's check the current distribution of values for each phenotype

```{r,fig.height=13,fig.width=10}

ggplot(phenolong,aes(value)) + geom_histogram() + facet_wrap(~variable,scales = "free",ncol=5)

```

Several weird values for several phenotypes

Now look at problematic data (extreme values)

Here are the treatments and experiments with leaf.numbers greater than 50

```{r,eval=TRUE}
phenolong %>% filter(variable=="leaf.number",value>50)%>%select(experiment,treatment)%>%distinct()
```

Looks ok, these are all from cofc-second (big pots and fert), we'll keep em.

#Some automated vetting of observations
I'm going to flag points that are outside the central 99% of all values for a phenotype as suspect.  We can then switch this off and on and look at the outlier effect in analyses below
```{r}

phenoquant <- phenolong %>% group_by(variable) %>% summarise(quantLo = quantile(value,0.005,na.rm=T),quantHi = quantile(value,0.995,na.rm=T))
phenolong.clipped = left_join(phenolong,phenoquant)
phenolong.clipped$inrange <- with(phenolong.clipped,ifelse((quantHi>=value)&(quantLo<=value),TRUE,FALSE))
```

For example, look at the ggplot from above now
```{r,fig.height=13,fig.width=10}
ggplot(phenolong.clipped%>%filter(inrange),aes(value)) + geom_histogram(bins=15) + facet_wrap(~variable,scales = "free",ncol=5)
```



#Biology instead of data integrity
##experiment 1 results
###Line means with columbia indicated in red and phytometers in blue.  Outliers excluded

Change phenolong.clipped to phenolong in the next chunk to take all the data.

This experiment 1 information now includes different experiments
```{r,fig.width=9}
phenolong.clipped$exp_fac = with(phenolong.clipped,paste0(experiment,'-',facility))
exp1long <- phenolong.clipped %>% filter(meta.experiment=="1",inrange) %>% group_by(variable,accession,exp_fac) %>% summarise(value=mean(value,na.rm=T)) 
exp1.col = exp1long %>% filter(accession%in%c("CS70000","CS60000","COL70000"))
exp1.phyt = exp1long %>% filter(grepl("CS",accession))
phenos=unique(exp1long$variable)
tmp=sapply(phenos,function(ph){
  tmpphen = exp1long[exp1long$variable==ph,]
#  if (ph=="fruitnum") {tmpphen = tmpphen[tmpphen$value<400,]}
  hist(tmpphen$value,main=paste("exp1",ph))
  tmpphyt=exp1.phyt %>% filter(variable==ph)
  tmpcol=exp1.col %>% filter(variable==ph)
  points(y=rep(0,dim(tmpphyt)[1]),x=tmpphyt$value, col="blue",pch=16, cex=1.1) #phytometers
  points(y=rep(0,dim(tmpcol)[1]),x=tmpcol$value, col="red",pch=16, cex=1.1) # columbia especially
  })

```

###Pairwise comparisons (outliers excluded)

```{r,warning=FALSE,fig.width=13,fig.height=14}
#phenos=c(unique(exp1long$variable))
phenos<- c("aborted.fruits","avg.fruit.length","basal.branch","days.to.bolt","diameter.at.bolt","fruitnum","germinants.14d","inflorescence.height", "ttl.maininfl.branch")
exp1long <- exp1long %>% filter(variable %in% c("experiment","facility",phenos))
exp1wide <- cast(exp1long)
paircompare <- exp1wide[,-1] %>%filter(inflorescence.height<250)

#paircompare=paircompare[complete.cases(paircompare),]
ggpairs(paircompare,lower=list(continuous="smooth"),aes(group=exp_fac))
```

##experiment 3 results
###Line means with columbia indicated in red and phytometers in blue.  Outliers excluded

Change phenolong.clipped to phenolong in the next chunk to take all the data
```{r,fig.width=9}
exp3long <- phenolong.clipped %>% filter(meta.experiment=="3",inrange) %>% group_by(variable,accession,experiment) %>% summarise(value=mean(value,na.rm=T)) 
exp3.col = exp3long %>% filter(accession%in%c("CS70000","CS60000","COL70000"))
exp3.phyt = exp3long %>% filter(grepl("CS",accession))
phenos=unique(exp3long$variable)
tmp=sapply(phenos,function(ph){
  tmpphen = exp3long[exp3long$variable==ph,]
 # if (ph=="fruitnum") {tmpphen = tmpphen[tmpphen$value<400,]}
  hist(tmpphen$value,main=paste("exp3",ph))
  tmpphyt=exp3.phyt %>% filter(variable==ph)
  tmpcol=exp3.col %>% filter(variable==ph)
  points(y=rep(0,dim(tmpphyt)[1]),x=tmpphyt$value, col="blue",pch=unclass(factor(tmpphyt$experiment)), cex=1.1) #phytometers
  points(y=rep(0,dim(tmpcol)[1]),x=tmpcol$value, col="red",pch=unclass(factor(tmpcol$experiment)), cex=2) # columbia especially
  })

```

###Pairwise comparisons (outliers excluded)

```{r,echo=FALSE,results=FALSE,warning=FALSE,fig.width=13,fig.height=14}
#phenos=c(unique(exp1long$variable))
phenos<- c("aborted.fruits","avg.fruit.length","basal.branch","days.to.bolt","diameter.at.bolt","fruitnum","germinants.14d","inflorescence.height", "ttl.maininfl.branch")
exp3long <- exp3long %>% filter(variable %in% c(phenos,"experiment"))
exp3wide <- cast(exp3long)
paircompare <- exp3wide[,-1]
#paircompare=paircompare[complete.cases(paircompare),]
suppressWarnings({ggpairs(exp3wide[,-1:-2],lower=list(continuous="smooth"))})
```

Could be a big 'experiment' effect:
```{r,echo=FALSE,results=FALSE,warning=FALSE,fig.width=13,fig.height=14}
suppressMessages({ggpairs(exp3wide[,-1],lower=list(continuous="smooth"),aes(group=experiment))})
```

##experiment 2 results
###Line means with columbia indicated in red and phytometers in blue.  Outliers excluded

Change phenolong.clipped to phenolong in the next chunk to take all the data
```{r,fig.width=9}
exp2long <- phenolong.clipped %>% filter(meta.experiment=="2",inrange) %>% group_by(variable,accession,treatment) %>% summarise(value=mean(value,na.rm=T)) 
exp2.col = exp2long %>% filter(accession%in%c("CS70000","CS60000","COL70000"))
exp2.phyt = exp2long %>% filter(grepl("CS",accession))
phenos=unique(exp2long$variable)
tmp=sapply(phenos,function(ph){
  tmpphen = exp2long[exp2long$variable==ph,]
  if (ph=="fruitnum") {tmpphen = tmpphen[tmpphen$value<400,]}
  hist(tmpphen$value,main=paste("exp2",ph))
  tmpphyt=exp2.phyt %>% filter(variable==ph)
  tmpcol=exp2.col %>% filter(variable==ph)
  points(y=rep(0,dim(tmpphyt)[1]),x=tmpphyt$value, col="blue",pch=unclass(factor(tmpphyt$experiment)), cex=1.1) #phytometers
  points(y=rep(0,dim(tmpcol)[1]),x=tmpcol$value, col="red",pch=unclass(factor(tmpcol$experiment)), cex=2) # columbia especially
  })

```

###Pairwise comparisons (outliers excluded)

```{r,fig.width=13,fig.height=14}
#phenos=c(unique(exp1long$variable))
phenos<- c("aborted.fruits","avg.fruit.length","basal.branch","days.to.bolt","diameter.at.bolt","fruitnum","germinants.14d","inflorescence.height", "ttl.maininfl.branch")
exp2long <- exp2long %>% filter(variable %in% c(phenos,"treatment"))
exp2wide <- cast(exp2long)
paircompare <- exp2wide[,-1]
#paircompare=paircompare[complete.cases(paircompare),]
ggpairs(paircompare,lower=list(continuous="smooth"),aes(group=treatment))
```


#Compare fruit number to other traits
##Experiment 1
```{r,fig.width=9,fig.height=9,warning=FALSE}

for (ph in unique(exp1long$variable))
{

  p = exp1wide%>%select_("exp_fac",ph,"fruitnum")%>%ggpairs(lower=list(continuous="smooth"),aes(group=exp_fac))
  print(p)
}

```

##Experiment 3
```{r,fig.width=9,fig.height=9,warning=FALSE}

for (ph in unique(exp3long$variable))
{

  p = exp3wide%>%select_("experiment",ph,"fruitnum")%>%ggpairs(lower=list(continuous="smooth"),aes(group=experiment))
  print(p)
}

```

##Experiment 2
```{r,fig.width=9,fig.height=9,warning=FALSE}

for (ph in unique(exp2long$variable))
{
  p = exp2wide%>%select_("treatment",ph,"fruitnum")%>%ggpairs(lower=list(continuous="smooth"),aes(group=treatment))
  print(p)
}

```
